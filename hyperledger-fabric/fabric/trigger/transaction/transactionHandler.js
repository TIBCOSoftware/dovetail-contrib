"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])};return function(t,a){function n(){this.constructor=t}e(t,a),t.prototype=null===a?Object.create(a):(n.prototype=a.prototype,new n)}}(),__decorate=this&&this.__decorate||function(e,t,a,n){var r,i=arguments.length,o=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,a):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,a,n);else for(var l=e.length-1;l>=0;l--)(r=e[l])&&(o=(i<3?r(o):i>3?r(t,a,o):r(t,a))||o);return i>3&&o&&Object.defineProperty(t,a,o),o},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),http_1=require("@angular/http"),Observable_1=require("rxjs/Observable"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),contrib_1=require("wi-studio/common/models/contrib"),validation_1=require("wi-studio/common/models/validation"),lodash=require("lodash"),transactionHandler=function(e){function t(t,a,n){var r=e.call(this,t,a,n)||this;return r.injector=t,r.http=a,r.contribModelService=n,r.value=function(e,t){if("commonData"===e)return Observable_1.Observable.create(function(e){wi_contrib_1.WiContributionUtils.getConnections(r.http,"fabric").subscribe(function(t){var a=[];t.forEach(function(e){if(e.isValid)for(var t=0;t<e.settings.length;t++)if("name"===e.settings[t].name){a.push({unique_id:wi_contrib_1.WiContributionUtils.getUniqueId(e),name:e.settings[t].value});break}}),e.next(a)})});if("parametersDataType"===e||"transientDataType"===e||"returnsDataType"===e){var a=t.getField("commonData").value;if(a)return Observable_1.Observable.create(function(e){wi_contrib_1.WiContributionUtils.getConnection(r.http,a).map(function(e){return e}).subscribe(function(t){for(var a=function(t){if("schema"===t.name&&t.value.value){var a=[""],n=JSON.parse(t.value.value);return Object.keys(n).forEach(function(e){Object.keys(n[e]).forEach(function(t){a.push(e+"."+t)})}),e.next(a),"break"}},n=0,r=t.settings;n<r.length;n++){if("break"===a(r[n]))break}})})}else if("parameters"===e||"transient"===e||"returns"===e){var n=t.getField(e+"DataType").value,i=t.getField("commonData").value;if(n&&i)return Observable_1.Observable.create(function(e){wi_contrib_1.WiContributionUtils.getConnection(r.http,i).map(function(e){return e}).subscribe(function(t){for(var a=0,r=t.settings;a<r.length;a++){var i=r[a];if("schema"===i.name&&i.value&&i.value.value){var o=JSON.parse(i.value.value),l=n.lastIndexOf("."),s=o[n.substring(0,l)];e.next(JSON.stringify(s[n.substring(l+1)],null,2));break}}})})}return null},r.validate=function(e,t){var a=validation_1.ValidationResult.newValidationResult();if("commonData"===e)return t.getMode()===contrib_1.MODE.WIZARD||t.getMode()===contrib_1.MODE.SERVERLESS_FLOW?a.setVisible(!0):a.setVisible(!1),a;if("parametersDataType"===e||"transientDataType"===e||"returnsDataType"===e){var n=validation_1.ValidationResult.newValidationResult();return t.getField("commonData").value?n.setVisible(!0):n.setVisible(!1),n}if("parameters"===e||"transient"===e||"returns"===e){if(t.getMode()===contrib_1.MODE.WIZARD||t.getMode()===contrib_1.MODE.SERVERLESS_FLOW){var r=validation_1.ValidationResult.newValidationResult(),i=t.getField(e),o=t.getField(e+"DataType");if(o.value&&o.display.visible?r.setReadOnly(!0):r.setReadOnly(!1),i.value&&i.value.value)try{var l=void 0;l=JSON.parse(i.value.value),l=JSON.stringify(l)}catch(e){return r.setError("FABTIC-TRIGGER-1000","Invalid JSON: "+e.toString())}return r.setReadOnly(!1),r}var s=validation_1.ValidationResult.newValidationResult();return s.setReadOnly(!0),s}return null},r.action=function(e,t){var a=r.getModelService(),n=wi_contrib_1.CreateFlowActionResult.newActionResult();if(t.handler&&t.handler.settings&&t.handler.settings.length>0){var i=t.getField("name"),o=t.getField("parameters"),l=t.getField("transient"),s=t.getField("returns"),u=o.value.value;u||(u=o.value);var c=l.value.value;c||(c=l.value);var v=s.value.value;if(v||(v=s.value),i&&i.value){var d=a.createTriggerElement("fabric/fabric-transaction");if(d&&d.handler&&d.handler.settings&&d.handler.settings.length>0)for(var f=0;f<d.handler.settings.length;f++)"name"===d.handler.settings[f].name&&(d.handler.settings[f].value=i.value);if(d&&d.outputs&&d.outputs.length>0)for(f=0;f<d.outputs.length;f++)"parameters"===d.outputs[f].name?d.outputs[f].value={value:u,metadata:""}:"transient"===d.outputs[f].name&&(d.outputs[f].value={value:c,metadata:""});if(d&&d.reply&&d.reply.length>0)for(f=0;f<d.reply.length;f++)if("returns"===d.reply[f].name){d.reply[f].value={value:v,metadata:""};break}var b=a.createFlow(i.value,t.getFlowDescription());n=n.addTriggerFlowMapping(lodash.cloneDeep(d),lodash.cloneDeep(b))}}return wi_contrib_1.ActionResult.newActionResult().setSuccess(!0).setResult(n)},r}return __extends(t,e),t}(wi_contrib_1.WiServiceHandlerContribution);transactionHandler=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__metadata("design:paramtypes",[core_1.Injector,http_1.Http,wi_contrib_1.WiContribModelService])],transactionHandler),exports.transactionHandler=transactionHandler;